os: Visual Studio 2017
configuration: Release

before_build:
  - nuget restore

build:
  verbosity: minimal
  parallel: true

build_script:
- ps: >-
    msbuild Octokit.GraphQL.sln --% /bl:output.binlog

on_finish:
- IF "%MSBLOC_TOKEN%x"=="x" echo MSBLOC Token not found
- IF NOT "%MSBLOC_TOKEN%x"=="x" '%USERPROFILE%\.nuget\packages\msbloc.msbuildlog.console\1.0.0\tools\net471\MSBLOC.MSBuildLog.Console.exe -i output.binlog -o checkrun.json -c "%APPVEYOR_BUILD_FOLDER%"'
- IF NOT "%MSBLOC_TOKEN%x"=="x" '%USERPROFILE%\.nuget\packages\msbloc.submission.console\1.0.0\tools\net471\MSBLOC.Submission.Console.exe' -i checkrun.json -t "%MSBLOC_TOKEN%" -h "%APPVEYOR_REPO_COMMIT%"

after_build:
  - nuget pack

after_test:
  - dotnet test -c Release --no-build /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:Exclude="[Octokit.GraphQL]Octokit.GraphQL.*" .\Octokit.GraphQL.UnitTests\Octokit.GraphQL.UnitTests.csproj
  - dotnet test -c Release --no-build /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:Exclude="[Octokit.GraphQL]Octokit.GraphQL.*" .\Octokit.GraphQL.Core.UnitTests\Octokit.GraphQL.Core.UnitTests.csproj
  - dotnet test -c Release --no-build /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:Exclude="[Octokit.GraphQL]Octokit.GraphQL.*" .\Octokit.GraphQL.Core.Generation.UnitTests\Octokit.GraphQL.Core.Generation.UnitTests.csproj
  - '%USERPROFILE%\.nuget\packages\codecov\1.0.5\tools\codecov.exe -f .\Octokit.GraphQL.UnitTests\coverage.opencover.xml'
  - '%USERPROFILE%\.nuget\packages\codecov\1.0.5\tools\codecov.exe -f .\Octokit.GraphQL.Core.UnitTests\coverage.opencover.xml'
  - '%USERPROFILE%\.nuget\packages\codecov\1.0.5\tools\codecov.exe -f .\Octokit.GraphQL.Core.Generation.UnitTests\coverage.opencover.xml'

artifacts:
  - path: '*.nupkg'
  - path: output.binlog
    name: log